<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.comvee.cdms.follow.mapper.FollowMapper" >
  <resultMap id="follow" type="com.comvee.cdms.follow.po.FollowPO" >
    <id column="sid" property="sid" jdbcType="BIGINT" />
    <result column="next_dt" property="nextDt" jdbcType="TIMESTAMP" />
    <result column="follow_dt" property="followDt" jdbcType="TIMESTAMP" />
    <result column="follow_type" property="followType" jdbcType="TINYINT" />
    <result column="member_id" property="memberId" jdbcType="BIGINT" />
    <result column="leader_id" property="leaderId" jdbcType="BIGINT" />
    <result column="doctor_id" property="doctorId" jdbcType="BIGINT" />
    <result column="doctor_name" property="doctorName"/>
    <result column="insert_dt" property="insertDt" jdbcType="TIMESTAMP" />
    <result column="modify_dt" property="modifyDt" jdbcType="TIMESTAMP" />
    <result column="is_valid" property="isValid" jdbcType="TINYINT" />
    <result column="archives_json" property="archivesJson" jdbcType="LONGVARCHAR" />
    <result column="deal_status" property="dealStatus"/>
    <result column="right_to_use_insulin" property="rightToUseInsulin"/>
    <result column="has_drug" property="hasDrug" jdbcType="TINYINT" />
    <result column="drug_list_json" property="drugListJson" jdbcType="LONGVARCHAR" />
    <result column="hbalc_date" property="hbalcDate" jdbcType="TIMESTAMP" />
    <result column="mqzywt" property="mqzywt"/>
    <result column="zygjcs" property="zygjcs"/>
    <result column="yqddmb" property="yqddmb"/>
    <result column="level_json" property="levelJson"/>
  </resultMap>

  <resultMap id="memberFollowSet" type="com.comvee.cdms.follow.po.MemberFollowSetPO">
    <!--

          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Tue Feb 06 14:46:56 CST 2018.

    -->
    <id column="sid" property="sid" jdbcType="BIGINT"/>
    <result column="member_id" property="memberId" jdbcType="BIGINT"/>
    <result column="leader_id" property="leaderId" jdbcType="BIGINT"/>
    <result column="doctor_id" property="doctorId" jdbcType="BIGINT"/>
    <result column="insert_dt" property="insertDt" jdbcType="TIMESTAMP"/>
    <result column="modify_dt" property="modifyDt" jdbcType="TIMESTAMP"/>
    <result column="is_valid" property="isValid" jdbcType="TINYINT"/>
    <result column="cycle_dt" property="cycleDt" jdbcType="TINYINT"/>
    <result column="next_dt" property="nextDt" jdbcType="TIMESTAMP"/>
    <result column="last_dt" property="lastDt" jdbcType="TIMESTAMP"/>
    <result column="last_follow_id" property="lastFollowId" jdbcType="BIGINT"/>
    <result column="follow_type" property="followType" jdbcType="TINYINT"/>
  </resultMap>

  <resultMap id="monthFollow" type="com.comvee.cdms.follow.po.CountMonthFollowPO">
    <result column="month" property="month"/>
    <result column="count" property="count"/>
  </resultMap>

  <resultMap id="followRemind" type="com.comvee.cdms.follow.po.FollowRemindPO">
    <id column="id" property="id" jdbcType="BIGINT"/>
    <result column="title" property="title" jdbcType="VARCHAR"/>
    <result column="type" property="type" jdbcType="TINYINT"/>
    <result column="follow_id" property="followId" jdbcType="BIGINT"/>
    <result column="doctor_id" property="doctorId" jdbcType="BIGINT"/>
    <result column="member_id" property="memberId" jdbcType="BIGINT"/>
    <result column="member_name" property="memberName" jdbcType="VARCHAR"  />
    <result column="is_do" property="isDo" jdbcType="TINYINT"/>
    <result column="is_valid" property="isValid" jdbcType="TINYINT"/>
    <result column="insert_dt" property="insertDt" jdbcType="TIMESTAMP"/>
    <result column="modify_dt" property="modifyDt" jdbcType="TIMESTAMP"/>
    <result column="before_day" property="beforeDay"/>
    <result column="template_id" property="templateId" jdbcType="BIGINT"/>
    <result column="follow_name" property="followName" jdbcType="VARCHAR"/>
  </resultMap>

  <resultMap id="followCustomerTemplate" type="com.comvee.cdms.follow.po.FollowCustomerTemplatePO">
    <id column="sid" property="sid"/>
    <result column="doctor_id" property="doctorId" />
    <result column="creator_id" property="creatorId"/>
    <result column="insert_dt" property="insertDt" />
    <result column="update_dt" property="updateDt"/>
    <result column="permission" property="permission"/>
    <result column="follow_name" property="followName"/>
    <result column="archives_json" property="archivesJson"/>
    <result column="is_valid" property="isValid" />
    <result column="hospital_id" property="hospitalId" />
    <result column="drug_json" property="drugJson"/>
    <result column="foot_json" property="footJson"/>
    <result column="question_type" property="questionType"/>
    <result column="add_json" property="addJson"/>
  </resultMap>
  <resultMap id="followCustomContent" type="com.comvee.cdms.follow.po.FollowCustomContentPO">
    <id column="sid" property="sid"/>
    <result column="archives_json" property="archivesJson" />
    <result column="drug_list_json" property="drugListJson"/>
    <result column="foot_json" property="footJson" />
    <result column="add_json" property="addJson"/>
    <result column="insert_dt" property="insertDt"/>
    <result column="update_dt" property="updateDt"/>
    <result column="is_valid" property="isValid" />
    <result column="member_id" property="memberId" />
    <result column="follow_dt" property="followDt"/>
    <result column="next_dt" property="nextDt"/>
    <result column="doctor_name" property="doctorName"/>
    <result column="doctor_id" property="doctorId"/>
    <result column="mqzywt" property="mqzywt"/>
    <result column="zygjcs" property="zygjcs"/>
    <result column="yqddmb" property="yqddmb"/>
  </resultMap>

  <resultMap id="followDiabetes" type="com.comvee.cdms.follow.po.FollowDiabetesPO">
    <id column="sid" jdbcType="BIGINT" property="sid" />
    <result column="follow_type" jdbcType="TINYINT" property="followType" />
    <result column="member_id" jdbcType="BIGINT" property="memberId" />
    <result column="doctor_id" jdbcType="BIGINT" property="doctorId" />
    <result column="is_valid" jdbcType="TINYINT" property="isValid" />
    <result column="follow_dt" jdbcType="DATE" property="followDt" />
    <result column="insert_dt" jdbcType="TIMESTAMP" property="insertDt" />
    <result column="update_dt" jdbcType="TIMESTAMP" property="updateDt" />
    <result column="follow_info" jdbcType="LONGVARCHAR" property="followInfo" />
    <result column="mqzywt" jdbcType="LONGVARCHAR" property="mqzywt" />
    <result column="zygjcs" jdbcType="LONGVARCHAR" property="zygjcs" />
    <result column="yqddmb" jdbcType="LONGVARCHAR" property="yqddmb" />
  </resultMap>

  <resultMap id="reportPO" type="com.comvee.cdms.follow.po.FollowReportPO">
    <id column="sid" jdbcType="BIGINT" property="sid" />
    <result column="follow_id" jdbcType="BIGINT" property="followId" />
    <result column="doctor_id" jdbcType="BIGINT" property="doctorId" />
    <result column="member_id" jdbcType="BIGINT" property="memberId" />
    <result column="report_type" jdbcType="TINYINT" property="reportType" />
    <result column="insert_dt" jdbcType="TIMESTAMP" property="insertDt" />
    <result column="update_dt" jdbcType="TIMESTAMP" property="updateDt" />
    <result column="is_valid" jdbcType="TINYINT" property="isValid" />
    <result column="report_json" jdbcType="LONGVARCHAR" property="reportJson" />
    <result column="week_blood_data" jdbcType="LONGVARCHAR" property="weekBloodData" />
    <result column="report_num" jdbcType="INTEGER" property="reportNum"/>
  </resultMap>

  <resultMap id="visitPO" type="com.comvee.cdms.follow.po.FollowMmcVisitPO">
    <id column="sid" jdbcType="BIGINT" property="sid" />
    <result column="member_info" jdbcType="BIGINT" property="memberInfo" />
    <result column="follow_info" jdbcType="BIGINT" property="followInfo" />
    <result column="drug_info" jdbcType="BIGINT" property="drugInfo" />
    <result column="diseases_info" jdbcType="TINYINT" property="diseasesInfo" />
    <result column="operation_info" jdbcType="TIMESTAMP" property="operationInfo" />
    <result column="other_drug" jdbcType="TIMESTAMP" property="otherDrug" />
    <result column="drinking_info" jdbcType="TINYINT" property="drinkingInfo" />
    <result column="is_valid" jdbcType="LONGVARCHAR" property="isValid" />
    <result column="insert_dt" jdbcType="LONGVARCHAR" property="insertDt" />
    <result column="modify_dt" jdbcType="INTEGER" property="modifyDt"/>
    <result column="member_id" jdbcType="TIMESTAMP" property="memberId" />
    <result column="follow_type" jdbcType="TINYINT" property="followType" />
    <result column="deal_status" jdbcType="LONGVARCHAR" property="dealStatus" />
  </resultMap>

  <resultMap id="followDrugDict" type="com.comvee.cdms.follow.po.FollowDrugDictPO">
    <id column="drug_id" jdbcType="BIGINT" property="drugId" />
    <result column="drug_name" jdbcType="BIGINT" property="drugName" />
    <result column="pid" jdbcType="BIGINT" property="pid" />
    <result column="drug_type" jdbcType="BIGINT" property="drugType" />
  </resultMap>

  <resultMap id="ListFollowPlatformRecordVO" type="com.comvee.cdms.follow.vo.ListFollowPlatformRecordVO">
    <id column="sid" jdbcType="BIGINT" property="sid" />
    <result column="follow_type" jdbcType="TINYINT" property="followType" />
    <result column="member_id" jdbcType="BIGINT" property="memberId" />
    <result column="doctor_id" jdbcType="BIGINT" property="doctorId" />
    <result column="follow_dt" jdbcType="DATE" property="followDt" />
    <result column="xltz" jdbcType="VARCHAR" property="xltz" />
    <result column="zyxw" jdbcType="VARCHAR" property="zyxw" />
    <result column="foreign_id" jdbcType="BIGINT" property="foreignId" />
    <result column="diseaseType" jdbcType="VARCHAR" property="diseaseType" />
    <result column="type" jdbcType="VARCHAR" property="type" />
    <result column="doctor_name" jdbcType="VARCHAR" property="doctorName" />
    <result column="xltz" jdbcType="VARCHAR" property="xltz" />
    <result column="zyxw" jdbcType="VARCHAR" property="zyxw" />
    <result column="mobile_phone" jdbcType="VARCHAR" property="mobilePhone" />
    <result column="sex" jdbcType="TINYINT" property="sex" />
    <result column="birthday" jdbcType="VARCHAR" property="birthday" />
    <result column="member_name" jdbcType="VARCHAR" property="memberName" />

  </resultMap>
  <sql id="Base_Column_List" >
    sid, next_dt, follow_dt, follow_type, member_id, leader_id, doctor_id, insert_dt, 
    modify_dt, is_valid,doctor_name,deal_status,level_json,
    archives_json, right_to_use_insulin, has_drug ,drug_list_json, hbalc_date, mqzywt, zygjcs, yqddmb
  </sql>
  <select id="listFollow" resultType="com.comvee.cdms.follow.model.FollowListModel">
    SELECT foreign_id sid, next_dt nextDt, fill_dt followDt, type followType, member_id memberId, leader_id leaderId,
    doctor_id doctorId, create_dt createDt, order_id orderId, package_name packageName, buy_dt buyDt, member_name memberName, telephone telephone,
    modify_dt modifyDt, is_valid isValid,doctor_name doctorName,status dealStatus,follow_name followName,template_id templateId, follow_type fType FROM t_follow_main
    where is_valid=1
    <if test="memberId != null and memberId!=''" >
      and member_id=#{memberId}
    </if>
    <if test="doctorId != null and doctorId!=''" >
      and leader_id=#{doctorId}
    </if>
    <if test="memberName != null and memberName!=''">
      and member_name like concat('%',concat(#{memberName},'%'))
    </if>
    <if test="followType != null and followType.size() > 0" >
      and type in
      <foreach collection="followType" item="item" open="(" close=")" separator=",">
          #{item}
      </foreach>
    </if>
    <if test="deal != null" >
      <if test="deal">
        and status=1
      </if>
      <if test="!deal">
        and status=0
      </if>
    </if>
    ORDER  BY insert_dt DESC
  </select>

  <select id="listFollowHx" resultType="com.comvee.cdms.follow.model.FollowListModel">
    select foreign_id sid, next_dt nextDt, fill_dt followDt, type followType, member_id memberId, leader_id leaderId,
    doctor_id doctorId, create_dt createDt, order_id orderId, package_name packageName, buy_dt buyDt, member_name memberName, telephone telephone,
    modify_dt modifyDt, is_valid isValid,doctor_name doctorName,status dealStatus,follow_name followName,template_id templateId  from t_follow_main
    where is_valid=1 and type=1 and follow_type=2 and status=1
    GROUP BY member_id
    ORDER BY modify_dt asc
  </select>

  <select id="getFollowById" resultMap="follow" >
    select
    <include refid="Base_Column_List" />
    from t_follow
    where sid=#{sid}
  </select>

  <insert id="insertFollow" parameterType="com.comvee.cdms.follow.po.FollowPO" >
    insert into t_follow (sid, next_dt, follow_dt, 
      follow_type, member_id,leader_id, doctor_name,
      doctor_id, insert_dt, modify_dt, is_valid, archives_json,
      right_to_use_insulin, has_drug,drug_list_json, hbalc_date, mqzywt, zygjcs, yqddmb, level_json
      )
    values (#{sid,jdbcType=BIGINT}, #{nextDt,jdbcType=TIMESTAMP}, #{followDt,jdbcType=TIMESTAMP}, 
      #{followType,jdbcType=TINYINT}, #{memberId,jdbcType=BIGINT}, #{leaderId,jdbcType=BIGINT}, #{doctorName},
      #{doctorId,jdbcType=BIGINT}, now(), now(),
      1, #{archivesJson,jdbcType=LONGVARCHAR}, #{rightToUseInsulin},
      #{hasDrug,jdbcType=TINYINT},#{drugListJson,jdbcType=LONGVARCHAR}, #{hbalcDate,jdbcType=TIMESTAMP},
      #{mqzywt}, #{zygjcs}, #{yqddmb}, #{levelJson}
      )
  </insert>

  <update id="modifyFollow" parameterType="com.comvee.cdms.follow.po.FollowPO" >
    update t_follow
    <set>
      modify_dt = now(),
      <if test="nextDt != null" >
        next_dt = #{nextDt,jdbcType=TIMESTAMP},
      </if>
      <if test="followDt != null" >
        follow_dt = #{followDt,jdbcType=TIMESTAMP},
      </if>
      <if test="doctorId != null and doctorId!=''" >
        doctor_id = #{doctorId},
      </if>
      <if test="doctorName != null and doctorName!=''" >
        doctor_name = #{doctorName},
      </if>
      <if test="followType != null" >
        follow_type = #{followType,jdbcType=TINYINT},
      </if>
      <if test="isValid != null" >
        is_valid = #{isValid,jdbcType=TINYINT},
      </if>
      <if test="archivesJson != null" >
        archives_json = #{archivesJson,jdbcType=LONGVARCHAR},
      </if>
      <if test="rightToUseInsulin != null" >
        right_to_use_insulin = #{rightToUseInsulin},
      </if>
      <if test="hasDrug != null" >
        has_drug = #{hasDrug,jdbcType=TINYINT},
      </if>
      <if test="hasDrug != null" >
        has_drug = #{hasDrug,jdbcType=TINYINT},
      </if>
      <if test="drugListJson != null" >
        drug_list_json = #{drugListJson,jdbcType=LONGVARCHAR},
      </if>
      <if test="mqzywt != null" >
        mqzywt = #{mqzywt},
      </if>
      <if test="zygjcs != null" >
        zygjcs = #{zygjcs},
      </if>
      <if test="yqddmb != null" >
        yqddmb = #{yqddmb},
      </if>
      <if test="dealStatus != null" >
        deal_status = #{dealStatus},
      </if>
      <if test="levelJson != null" >
        level_json = #{levelJson},
      </if>
      <if test="hbalcDate != null" >
        hbalc_date = #{hbalcDate}
      </if>
    </set>
    where sid = #{sid,jdbcType=BIGINT}
  </update>

  <select id="listFollowMemberId" resultType="java.lang.String">
    select tff.member_id memberId,tdm.is_valid from t_follow_main tff left join t_doctor_member tdm
    on tff.leader_id = tdm.doctor_id and tff.member_id=tdm.member_id
    where  tff.is_valid=1 and (tdm.is_valid=1 or tdm.is_valid is null) and tff.leader_id= #{leaderId}
    GROUP BY tff.member_id
    order by tff.insert_dt desc
  </select>

  <select id="listFollowSetByMemberIds" resultType="com.comvee.cdms.follow.model.FollowMemberModel">
    select tf.member_id memberId,tf.next_dt nextFollowDate,tf.last_follow_id lastFollowSid,tf.sid followSetId
    from t_member_follow_set tf where tf.member_id in
    <foreach collection="memberIds" separator="," open="(" item="item" close=")" index="index">
      #{item}
    </foreach>
    and tf.leader_id = #{leaderId}
  </select>

  <sql id="Base_Set_Column_List">
    <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Tue Feb 06 14:46:56 CST 2018.

    -->
    sid, member_id, leader_id, doctor_id, insert_dt, modify_dt, is_valid, cycle_dt, next_dt, last_dt, last_follow_id, follow_type
  </sql>


  <select id="getMemberFollowSetById" resultMap="memberFollowSet">
    <!--

          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Tue Feb 06 14:46:56 CST 2018.

    -->
    select
    <include refid="Base_Set_Column_List"/>
    from t_member_follow_set
    WHERE sid = #{sid}
  </select>

  <select id="getMemberFollowSetByDoc" resultMap="memberFollowSet">
    <!--

          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Tue Feb 06 14:46:56 CST 2018.

    -->
    select
    <include refid="Base_Set_Column_List"/>
    from t_member_follow_set
    WHERE member_id = #{memberId} and leader_id = #{leaderId} and follow_type = #{followType}
  </select>

  <select id="getMemberFollowSetByDocNew" resultMap="memberFollowSet">
    <!--

          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Tue Feb 06 14:46:56 CST 2018.

    -->
    select
    <include refid="Base_Set_Column_List"/>
    from t_member_follow_set
    WHERE member_id = #{memberId} and leader_id = #{leaderId}
    order by modify_dt desc LIMIT 1
  </select>

  <insert id="insertMemberFollowSet" parameterType="com.comvee.cdms.follow.po.MemberFollowSetPO">
    <!--

          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Tue Feb 06 14:46:56 CST 2018.

    -->
    insert into t_member_follow_set (sid, member_id, leader_id, doctor_id, insert_dt, modify_dt, is_valid, cycle_dt, next_dt, last_dt, last_follow_id, follow_type )
    values (#{sid,jdbcType=BIGINT}, #{memberId,jdbcType=BIGINT}, #{leaderId,jdbcType=BIGINT},
    #{doctorId,jdbcType=BIGINT}, now(), now(),
    1, #{cycleDt,jdbcType=TINYINT}, #{nextDt,jdbcType=TIMESTAMP},
    #{lastDt,jdbcType=TIMESTAMP}, #{lastFollowId,jdbcType=BIGINT},
    #{followType,jdbcType=TINYINT} )
  </insert>

  <update id="modifyMemberFollowSet" parameterType="com.comvee.cdms.follow.po.MemberFollowSetPO">
    <!--

          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Tue Feb 06 14:46:56 CST 2018.

    -->
    update t_member_follow_set
    <set>
      modify_dt = now(),
      <if test="doctorId != null">doctor_id = #{doctorId,jdbcType=BIGINT},</if>
      <if test="insertDt != null">insert_dt = #{insertDt,jdbcType=TIMESTAMP},</if>
      <if test="isValid != null">is_valid = #{isValid,jdbcType=TINYINT},</if>
      <if test="cycleDt != null">cycle_dt = #{cycleDt,jdbcType=TINYINT},</if>
      <if test="nextDt != null and nextDt != ''">next_dt = #{nextDt,jdbcType=TIMESTAMP},</if>
      <if test="lastDt != null">last_dt = #{lastDt,jdbcType=TIMESTAMP},</if>
      <if test="lastFollowId != null and lastFollowId!=''">last_follow_id = #{lastFollowId,jdbcType=BIGINT},</if>
      <if test="followType != null">follow_type = #{followType,jdbcType=TINYINT},</if>
    </set>
    where sid = #{sid,jdbcType=BIGINT}
  </update>

  <resultMap id="mainFollow" type="com.comvee.cdms.follow.po.MainFollowPO">
    <!--

          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Tue Mar 27 09:38:18 CST 2018.

    -->
    <id column="sid" property="sid" jdbcType="BIGINT"/>
    <result column="type" property="type" jdbcType="INTEGER"/>
    <result column="next_dt" property="nextDt" jdbcType="TIMESTAMP"/>
    <result column="fill_form_by" property="fillFormBy" jdbcType="INTEGER"/>
    <result column="status" property="status" jdbcType="INTEGER"/>
    <result column="final_fill_form_by" property="finalFillFormBy" jdbcType="INTEGER"/>
    <result column="doctor_id" property="doctorId" jdbcType="BIGINT"/>
    <result column="leader_id" property="leaderId" jdbcType="BIGINT"/>
    <result column="create_dt" property="createDt" jdbcType="TIMESTAMP"/>
    <result column="fill_dt" property="fillDt" jdbcType="TIMESTAMP"/>
    <result column="insert_dt" property="insertDt" jdbcType="TIMESTAMP"/>
    <result column="modify_dt" property="modifyDt" jdbcType="TIMESTAMP"/>
    <result column="is_valid" property="isValid" jdbcType="INTEGER"/>
    <result column="foreign_id" property="foreignId" jdbcType="BIGINT"/>
    <result column="member_id" property="memberId" jdbcType="BIGINT"/>
    <result column="doctor_name" property="doctorName"/>

    <result column="order_id" property="orderId" jdbcType="BIGINT"/>
    <result column="package_name" property="packageName"/>
    <result column="buy_dt" property="buyDt" jdbcType="TIMESTAMP"/>
    <result column="member_name" property="memberName"/>
    <result column="telephone" property="telephone"/>
    <result column="follow_type" property="followType"/>
    <result column="follow_name" property="followName"/>
    <result column="template_id" property="templateId"/>
  </resultMap>
  <sql id="Main_Follow_List">
    <!--

          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Tue Mar 27 09:38:18 CST 2018.

    -->
    sid, type, next_dt, fill_form_by, status, final_fill_form_by, doctor_id, leader_id, create_dt, fill_dt,
    insert_dt, modify_dt, is_valid, foreign_id, member_id,doctor_name, order_id, package_name, buy_dt, member_name,
    telephone,follow_type,follow_name,template_id
  </sql>

  <select id="getMainFollowByFidAndType" resultMap="mainFollow">
    <!--

          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Tue Mar 27 09:38:18 CST 2018.

    -->
    select
    <include refid="Main_Follow_List"/>
    from t_follow_main where foreign_id = #{foreignId} 
    <if test = "type != null and '' != type">
        and type = #{type}
    </if>
  </select>

  <update id="modifyMainFollow" parameterType="com.comvee.cdms.follow.po.MainFollowPO">
    <!--

          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Tue Mar 27 09:38:18 CST 2018.

    -->
    update t_follow_main
    <set>modify_dt = now(),
      <if test="nextDt != null">next_dt = #{nextDt,jdbcType=TIMESTAMP},</if>
      <if test="status != null">status = #{status,jdbcType=INTEGER},</if>
      <if test="finalFillFormBy != null">
        final_fill_form_by = #{finalFillFormBy,jdbcType=INTEGER},
      </if>
      <if test="fillDt != null">fill_dt = #{fillDt,jdbcType=TIMESTAMP},</if>
      <if test="isValid != null">is_valid = #{isValid,jdbcType=INTEGER},</if>
      <if test="doctorId != null and doctorId!=''" >
        doctor_id = #{doctorId},
      </if>
      <if test="doctorName != null and doctorName!=''" >
        doctor_name = #{doctorName},
      </if>
    </set>
    where sid = #{sid,jdbcType=BIGINT}
  </update>

  <update id="modifyMainFollowByFid" parameterType="com.comvee.cdms.follow.po.MainFollowPO">
    <!--

          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Tue Mar 27 09:38:18 CST 2018.

    -->
    update t_follow_main
    <set>modify_dt = now(),
      <if test="nextDt != null">next_dt = #{nextDt,jdbcType=TIMESTAMP},</if>
      <if test="status != null">status = #{status,jdbcType=INTEGER},</if>
      <if test="finalFillFormBy != null">
        final_fill_form_by = #{finalFillFormBy,jdbcType=INTEGER},
      </if>
      <if test="fillDt != null">fill_dt = #{fillDt,jdbcType=TIMESTAMP},</if>
      <if test="isValid != null">is_valid = #{isValid,jdbcType=INTEGER},</if>
      <if test="doctorId != null and doctorId!=''" >
        doctor_id = #{doctorId},
      </if>
      <if test="doctorName != null and doctorName!=''" >
        doctor_name = #{doctorName},
      </if>
    </set>
    where foreign_id = #{foreignId}
  </update>

  <insert id="insertMainFollow" parameterType="com.comvee.cdms.follow.po.MainFollowPO">
    <!--

          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Tue Mar 27 09:38:18 CST 2018.

    -->
    insert into t_follow_main (sid, type, next_dt, fill_form_by, status, final_fill_form_by, doctor_id,
    leader_id, create_dt, fill_dt, insert_dt, modify_dt, is_valid, foreign_id, member_id,doctor_name,
    order_id, package_name, buy_dt, member_name, telephone, follow_type,follow_name,template_id,hospital_id)
    values (#{sid,jdbcType=BIGINT}, #{type,jdbcType=INTEGER}, #{nextDt,jdbcType=TIMESTAMP}, #{fillFormBy,jdbcType=INTEGER},
    #{status,jdbcType=INTEGER}, #{finalFillFormBy,jdbcType=INTEGER}, #{doctorId,jdbcType=BIGINT}, #{leaderId,jdbcType=BIGINT},
    #{createDt,jdbcType=TIMESTAMP}, #{fillDt,jdbcType=TIMESTAMP}, now(), now(),
    1, #{foreignId,jdbcType=BIGINT}, #{memberId,jdbcType=BIGINT} , #{doctorName},
    #{orderId,jdbcType=BIGINT}, #{packageName}, #{buyDt,jdbcType=TIMESTAMP}, #{memberName}, #{telephone}, #{followType},#{followName},#{templateId},#{hospitalId})
  </insert>

  <resultMap id="followup" type="com.comvee.cdms.follow.po.FollowupPO">
    <!--

          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Mar 28 09:56:04 CST 2018.

    -->
    <id column="sid" property="sid" jdbcType="BIGINT"/>
    <result column="is_valid" property="isValid" jdbcType="INTEGER"/>
    <result column="insert_dt" property="insertDt" jdbcType="TIMESTAMP"/>
    <result column="modify_dt" property="modifyDt" jdbcType="TIMESTAMP"/>
    <result column="member_info" property="memberInfo" jdbcType="LONGVARCHAR"/>
    <result column="follow_info" property="followInfo" jdbcType="LONGVARCHAR"/>
    <result column="member_id" property="memberId" jdbcType="BIGINT"/>
    <result column="drug_list_json" property="drugListJson" jdbcType="LONGVARCHAR"/>
  </resultMap>

  <sql id="Followup_List">
    <!--

          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Mar 28 09:56:04 CST 2018.

    -->
    sid, is_valid, insert_dt, modify_dt,member_info, follow_info,member_id,drug_list_json
  </sql>
  <select id="getFollowupById" resultMap="followup" parameterType="String">
    <!--

          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Mar 28 09:56:04 CST 2018.

    -->
    select
    <include refid="Followup_List"/>
    from t_followup where sid = #{sid}
  </select>

  <insert id="insertFollowup" parameterType="com.comvee.cdms.follow.po.FollowupPO">
    <!--

          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Mar 28 09:56:04 CST 2018.

    -->
    insert into t_followup (sid, is_valid, insert_dt, modify_dt, member_info, follow_info,member_id,drug_list_json)
    values (#{sid,jdbcType=BIGINT}, 1, now(), now(), #{memberInfo,jdbcType=LONGVARCHAR}, #{followInfo,jdbcType=LONGVARCHAR},#{memberId},#{drugListJson} )
  </insert>

  <update id="modifyFollowup" parameterType="map">
    <!--

          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Wed Mar 28 09:56:04 CST 2018.

    -->
    update t_followup
    <set>
      modify_dt = now(),
      <if test="po.isValid != null">is_valid = #{po.isValid,jdbcType=INTEGER},</if>
      <if test="po.memberInfo != null">
        member_info = #{po.memberInfo,jdbcType=LONGVARCHAR},
      </if>
      <if test="po.followInfo != null">
        follow_info = #{po.followInfo,jdbcType=LONGVARCHAR},
      </if>
      <if test="po.drugListJson != null">
        drug_list_json = #{po.drugListJson,jdbcType=LONGVARCHAR},
      </if>
    </set>
    WHERE sid = #{po.sid}
  </update>

  <select id="countFollow" parameterType="com.comvee.cdms.follow.dto.CountFollowDTO" resultType="long">
    select count(*) from t_follow_main t where t.is_valid = 1
    <if test = "doctorId != null and '' != doctorId">
      and t.doctor_id = #{doctorId}
    </if>
    <if test = "followStatus != null">
      and t.`status` = #{followStatus}
    </if>

  </select>

  <select id="countMonthFollow" parameterType="com.comvee.cdms.follow.dto.CountMonthFollowDTO" resultMap="monthFollow">
    select DATE_FORMAT(t.insert_dt,'%m') month, count(t.sid) count from t_follow_main t
    where t.is_valid = 1 and DATE_FORMAT(t.insert_dt,'%Y') = #{year} and t.status=1
    and t.doctor_id = #{doctorId}
    group by DATE_FORMAT(t.insert_dt, '%Y-%m')
  </select>


  <select id="listFollowRemind" resultMap="followRemind" parameterType="com.comvee.cdms.follow.dto.ListFollowRemindDTO">
    select id, title, type, follow_id, doctor_id, member_id, member_name, is_do,
    is_valid, insert_dt, modify_dt,before_day
    from t_follow_remind
    where is_valid=1 and is_do=0
    <if test="memberName != null and memberName!=''">
      and member_name like concat('%',concat(#{memberName},'%'))
    </if>
    <if test = "type != null and '' != type">
      and type = #{type}
    </if>
    <if test="doctorIdList!=null and doctorIdList.size()&gt;0">
      AND doctor_id IN
      <foreach collection="doctorIdList" close=")" open="(" index="index" item="item" separator=",">
        #{item}
      </foreach>
    </if>
    order by insert_dt desc
  </select>

  <select id="getFollowRemind" resultMap="followRemind" parameterType="com.comvee.cdms.follow.po.FollowRemindPO">
    select id, title, type, follow_id, doctor_id, member_id, member_name, is_do,
    is_valid, insert_dt, modify_dt,before_day
    from t_follow_remind
    where is_valid=1
    <if test = "followId != null and '' != followId">
      and follow_id = #{followId}
    </if>
    <if test = "type != null and '' != type">
      and type = #{type}
    </if>
    order by insert_dt desc  LIMIT 1
  </select>

  <select id="countFollowRemind" parameterType="com.comvee.cdms.follow.dto.ListFollowRemindDTO" resultType="long">
    select count(*) from t_follow_remind t where t.is_valid = 1 and is_do=0
<!--    <if test="followTypeList!=null and followTypeList.size()>0">-->
<!--      and t.type in-->
<!--      <foreach collection="followTypeList" index="index" item="item" open="(" close=")" separator=",">-->
<!--        #{item}-->
<!--      </foreach>-->
<!--    </if>-->
    <if test="doctorIdList!=null and doctorIdList.size()&gt;0">
      AND doctor_id IN
      <foreach collection="doctorIdList" close=")" open="(" index="index" item="item" separator=",">
        #{item}
      </foreach>
    </if>
  </select>

  <insert id="insertFollowRemind" parameterType="com.comvee.cdms.follow.po.FollowRemindPO" >
    insert into t_follow_remind (id, title, type, follow_id, doctor_id, member_id, member_name, is_do,
    is_valid, insert_dt, modify_dt,before_day )
    values (#{id}, #{title}, #{type},#{followId},#{doctorId},#{memberId},#{memberName},#{isDo},
    1, now(), now(),#{beforeDay} )
  </insert>

  <update id="modifyFollowRemind" parameterType="com.comvee.cdms.follow.po.FollowRemindPO" >
    update t_follow_remind
    <set >
      modify_dt = now(),
      <if test = "isDo != null and '' != isDo">
        is_do = #{isDo},
      </if>
      <if test = "isValid != null and '' != isValid">
        is_valid = #{isValid},
      </if>
    </set>
    where id = #{id}
  </update>
  
  <!-- gwx -->
  <select id="countFollowForMember" parameterType="com.comvee.cdms.app.doctorapp.vo.CountFollowReqVO" resultType="long">
    select count(*) from t_follow_main t where t.is_valid = 1
    <if test = "memberId != null and '' != memberId">
      and t.member_id = #{memberId}
    </if>
    <if test = "dealStatus != null and '' != dealStatus">
      and t.status = #{dealStatus}
    </if>    
<!--    <if test = "type != null and '' != type">
      and t.status = #{dealStatus}
    </if>    -->
  </select>

  <select id="listMemberRevisitDoctor" resultType="string">
      SELECT t.doctor_id FROM `t_follow_main` t where t.is_valid = 1
      and t.`status` = 1 and t.member_id = #{memberId}  and t.next_dt = #{nextDt}
  </select>

  <select id="listHasFirstFollowMember" resultType="string">
    select t.member_id from t_follow_main t where t.type = #{followType}
    and t.member_id in
    <foreach collection="memberList" item = "item" open="(" close=")" separator=",">
      #{item}
    </foreach>
    group by t.member_id
  </select>

  <select id="listFollowDay" parameterType="com.comvee.cdms.follow.model.FollowDayDTO" resultType="com.comvee.cdms.follow.model.FollowDayModel">

    SELECT a.foreign_id as foreignId,a.type,a.status,a.doctor_id AS doctorId,a.member_id AS memberId,
     b.member_info AS memberInfo,b.follow_info AS followInfo,b.is_valid AS isValid,DATE_FORMAT(b.insert_dt,'%Y-%m-%d %H:%i:%s')AS insertDt,DATE_FORMAT(b.modify_dt,'%Y-%m-%d %H:%i:%s')AS modifyDt,b.drug_list_json AS drugListJson
    FROM t_follow_main a JOIN t_followup b ON a.foreign_id=b.sid AND a.status=1 AND b.is_valid=1
    <if test="memberId != null and ''!= memberId">
      AND a.member_id=#{memberId}
    </if>
    <if test="doctorId != null and '' != doctorId">
      AND a.doctor_id=#{doctorId}
    </if>
    <if test="type != null and '' != type">
      AND a.type=#{type}
    </if>
    <if test="status != null and '' != status">
      AND a.status=#{status}
    </if>    
    <if test="endTime != null and '' != endTime">
      AND b.modify_dt &lt;= #{endTime} 
    </if>       
    ORDER BY b.modify_dt DESC
  </select>

  <insert id="addFollowCustomerTemplate" parameterType="com.comvee.cdms.follow.po.FollowCustomerTemplatePO">
    insert into t_follow_custom_template (sid,doctor_id,creator_id,insert_dt,update_dt,permission,follow_name,archives_json,is_valid,hospital_id,
    drug_json,foot_json,question_type,add_json)
    values(#{sid},#{doctorId},#{creatorId},now(),now(),#{permission},#{followName},#{archivesJson},1,#{hospitalId},#{drugJson},#{footJson},#{questionType},#{addJson})
  </insert>

  <update id="modifyFollowCustomerTemplate" parameterType="com.comvee.cdms.follow.po.FollowCustomerTemplatePO">
    update t_follow_custom_template
    <set>
      update_dt = now(),archives_json=#{archivesJson},drug_json=#{drugJson},foot_json=#{footJson},question_type=#{questionType},add_json=#{addJson},
      <if test="permission != null">
         permission = #{permission},
      </if>
      <if test="followName != null and '' != followName">
         follow_name = #{followName},
      </if>
    </set>
    where sid = #{sid}
  </update>

  <select id="getTemplateByName" parameterType="java.lang.String" resultMap="followCustomerTemplate">
    select sid,doctor_id,creator_id,insert_dt,update_dt,permission,follow_name,archives_json,is_valid,hospital_id,drug_json,foot_json,question_type,add_json
    from t_follow_custom_template
    where follow_name = #{followName} and is_valid=1
    limit 1
  </select>

  <select id="getTemplateById" parameterType="java.lang.String" resultMap="followCustomerTemplate">
    select sid,doctor_id,creator_id,insert_dt,update_dt,permission,follow_name,archives_json,is_valid,hospital_id,drug_json,foot_json,question_type,add_json
    from t_follow_custom_template
    where sid = #{sid}
  </select>

  <select id="listFollowCustomerTemplate" parameterType="java.lang.String" resultMap="followCustomerTemplate">
    select sid,doctor_id,creator_id,insert_dt,update_dt,permission,follow_name,archives_json,is_valid,hospital_id,drug_json,foot_json,question_type,add_json
    from t_follow_custom_template
    where ((doctor_id = #{doctorId} and permission = 2) or (permission = 1 and hospital_id = #{hospitalId}))
    and is_valid=1
  </select>

  <insert id="insertFollowCustomContent" parameterType="com.comvee.cdms.follow.po.FollowCustomContentPO">
    insert into t_follow_custom_content (sid, archives_json,drug_list_json,foot_json,add_json,is_valid, insert_dt,
    update_dt,member_id,follow_dt,next_dt,doctor_name,doctor_id)
    values (#{sid}, #{archivesJson}, #{drugListJson},#{footJson},#{addJson}, 1, now(), now(),#{memberId},#{followDt},#{nextDt},#{doctorName},#{doctorId})
  </insert>

  <update id="modifyFollowCustomContent" parameterType="com.comvee.cdms.follow.po.FollowCustomContentPO">
    update t_follow_custom_content
    <set>
      update_dt = now(),
      <if test="archivesJson != null">
        archives_json = #{archivesJson},
      </if>
      <if test="drugListJson != null">
        drug_list_json = #{drugListJson},
      </if>
      <if test="footJson != null">
        foot_json = #{footJson},
      </if>
      <if test="addJson != null">
        add_json = #{addJson},
      </if>
      <if test="followDt != null">
        follow_dt = #{followDt},
      </if>
      <if test="nextDt != null">
        next_dt = #{nextDt},
      </if>
      <if test="mqzywt != null">
        mqzywt = #{mqzywt},
      </if>
      <if test="zygjcs != null">
        zygjcs = #{zygjcs},
      </if>
      <if test="yqddmb != null">
        yqddmb = #{yqddmb},
      </if>
    </set>
    WHERE sid = #{sid}
  </update>

  <select id="getFollowCustomContentById" resultMap="followCustomContent" parameterType="java.lang.String">
    select sid,archives_json,drug_list_json,foot_json,add_json,insert_dt,update_dt,is_valid,member_id,DATE_FORMAT(follow_dt,'%Y-%m-%d') as followDt,
    DATE_FORMAT(next_dt,'%Y-%m-%d') nextDt,doctor_name,doctor_id,mqzywt,zygjcs,yqddmb
    from t_follow_custom_content where sid = #{sid}
  </select>

  <select id="countNewFollow" resultType="long" parameterType = "com.comvee.cdms.statistics.dto.SynthesizeDataDTO">
    select count(*) from t_follow_main p,t_doctor d
    where p.leader_id = d.doctor_id and p.is_valid = 1
    <if test="followStatus != null and ''!=followStatus">
      and p.status = #{followStatus}
    </if>
    <if test="leaderId != null and ''!=leaderId">
      and p.leader_id = #{leaderId}
    </if>
    <if test="doctorId != null and ''!=doctorId">
      and p.doctor_id = #{doctorId}
    </if>
    <if test="memberId != null and ''!=memberId">
      and p.member_id = #{memberId}
    </if>
    <if test="hospitalId != null and ''!=hospitalId">
      and d.hospital_id = #{hospitalId}
    </if>
    <if test="departmentId != null and ''!=departmentId">
      and d.depart_id = #{departmentId}
    </if>
    <if test="startDt != null and ''!=startDt">
      and p.insert_dt &gt;= #{startDt}
    </if>
    <if test="endDt != null and ''!=endDt">
      and p.insert_dt &lt;= #{endDt}
    </if>
  </select>

  <select id="listMemberFollowSet" resultType="com.comvee.cdms.follow.model.FollowMemberModel">
    SELECT a.member_id memberId,a.leader_id leaderId,a.next_dt nextFollowDate,a.last_follow_id lastFollowSid,a.sid followSetId FROM
    (SELECT member_id ,next_dt ,last_follow_id ,sid ,leader_id
    FROM t_member_follow_set ORDER BY next_dt DESC) a
    GROUP BY a.member_id,a.leader_id
  </select>

  <select id="countMonthFollowForHos" parameterType="com.comvee.cdms.statistics.dto.GetStatisticsDTO" resultMap="monthFollow">
    <!--visitType类型 1住院 2门诊&居家 -->
    <if test="visitType==1">
      select DATE_FORMAT(m.insert_dt,'%Y-%m') yearMonth, count(m.sid) count from t_follow_main m
      join t_member_in_hospital_log h
      on m.member_id=h.member_id
      where h.is_valid=1
      <if test="hospitalId!=null and hospitalId!=''">
        and h.hospital_id=#{hospitalId}
      </if>
      <if test="startDt!=null and startDt!='' and endDt != null and endDt!=''">
        and (h.out_hospital_date between #{startDt} and #{endDt}
        or in_status=1)
        and m.insert_dt between #{startDt} and #{endDt}
      </if>
      <!--and DATE_FORMAT(m.insert_dt,'%Y') = #{year} -->
      and m.status=1
      group by DATE_FORMAT(m.insert_dt, '%Y-%m')
    </if>
    <if test="visitType==2">
      select DATE_FORMAT(m.insert_dt,'%Y-%m') yearMonth, count(m.sid) count from t_follow_main m
      join t_doctor d on m.doctor_id=d.doctor_id
      <if test="hospitalId!=null and hospitalId!=''">
        and d.hospital_id=#{hospitalId}
      </if>
      LEFT JOIN (select * from t_member_visit
      where visit_date BETWEEN DATE_FORMAT(date_add(#{endDt}, interval -7 day),'%Y-%m-%d 00:00:00')
      and DATE_FORMAT(#{endDt},'%Y-%m-%d %H:%i:%s') group by member_id) v
      ON m.member_id = v.member_id and d.depart_id = v.depart_code
      and v.hospital_id=d.hospital_id
      where (m.is_valid=1
      <if test="doctorIdList!=null and doctorIdList.size&gt;0">
        and m.doctor_id in
        <foreach collection="doctorIdList" index="index" item="item" open="(" close=")" separator=",">
          #{item}
        </foreach>
      </if>
      <if test="startDt!=null and startDt!='' and endDt != null and endDt!=''">
        and m.insert_dt between #{startDt} and #{endDt}
      </if>
      <!--and DATE_FORMAT(m.insert_dt,'%Y') = #{year} -->
      and m.status=1)
      OR (v.sid IS NOT NULL
      <if test="startDt!=null and startDt!='' and endDt != null and endDt!=''">
        and m.insert_dt between #{startDt} and #{endDt}
      </if>
      <!--and DATE_FORMAT(m.insert_dt,'%Y') = #{year} -->
      and m.status=1 and m.is_valid=1)
      group by DATE_FORMAT(m.insert_dt, '%Y-%m')
    </if>
  </select>

  <select id="countFollowForHos" parameterType="com.comvee.cdms.statistics.dto.GetStatisticsDTO" resultType="long">
    <!--visitType类型 1住院 2门诊&居家 -->
    <if test="visitType==1">
      select count(1) from (
      select m.* from t_follow_main m
      join t_member_in_hospital_log h
      on m.member_id=h.member_id
      where h.is_valid=1
      <if test="departIdList!=null and departIdList.size()&gt;0">
        and h.department_id in
        <foreach collection="departIdList" index="index" item="item" open="(" close=")" separator=",">
          #{item}
        </foreach>
      </if>
      <if test="hospitalId!=null and hospitalId!=''">
        and h.hospital_id=#{hospitalId}
      </if>
      <if test="startDt!=null and startDt!='' and endDt != null and endDt!=''">
        and m.insert_dt between #{startDt} and #{endDt}
        and (h.out_hospital_date between #{startDt} and #{endDt}
        or in_status=1)
      </if>
      )cnt
    </if>
    <if test="visitType==2">
      select count(1) from (
      select m.member_id from t_follow_main m
      join t_doctor_member dm on m.member_id = dm.member_id
      and m.leader_id=dm.doctor_id
      join t_doctor d on dm.doctor_id=d.doctor_id
      <if test="hospitalId!=null and hospitalId!=''">
        and d.hospital_id=#{hospitalId}
      </if>
      LEFT JOIN (select * from t_member_visit
      where visit_date BETWEEN DATE_FORMAT(date_add(#{endDt}, interval -7 day),'%Y-%m-%d 00:00:00')
      and DATE_FORMAT(#{endDt},'%Y-%m-%d %H:%i:%s') group by member_id) v
      ON m.member_id = v.member_id and d.depart_id = v.depart_code
      and v.hospital_id=d.hospital_id
      where (dm.is_valid=1 and m.is_valid=1
      <if test="doctorIdList!=null and doctorIdList.size&gt;0">
        and dm.doctor_id in
        <foreach collection="doctorIdList" index="index" item="item" open="(" close=")" separator=",">
          #{item}
        </foreach>
      </if>
      <if test="startDt!=null and startDt!='' and endDt != null and endDt!=''">
        and m.insert_dt between #{startDt} and #{endDt}
      </if>)
      OR (v.sid IS NOT NULL
      <if test="startDt!=null and startDt!='' and endDt != null and endDt!=''">
        and m.insert_dt between #{startDt} and #{endDt}
      </if>
      and m.is_valid=1)
      )cnt
    </if>
  </select>

  <select id="listFollowTemplateByPerson"  resultMap="followCustomerTemplate">
    select sid,doctor_id,creator_id,insert_dt,update_dt,permission,follow_name,archives_json,is_valid,hospital_id,drug_json,foot_json,question_type,add_json
    from t_follow_custom_template
    where is_valid = 1
    <if test="doctorList != null and doctorList.size() > 0">
      and  doctor_id in
      <foreach collection="doctorList" open="(" close=")" separator="," item="item">
        #{item}
      </foreach>
    </if>
    <if test="keyword!=null and keyword!=''">
      and instr(follow_name , #{keyword}) > 0
    </if>
    order by update_dt desc
  </select>

  <update id="deleteFollowTemplate" parameterType="com.comvee.cdms.follow.dto.DeleteFollowCustomDTO">
    update t_follow_custom_template set is_valid = 0,update_dt = now()
    <where>
      <if test="ids != null and ids.size() > 0">
        and sid in
        <foreach collection="ids" open="(" close=")" separator="," item="item">
          #{item}
        </foreach>
      </if>
    </where>
  </update>

  <select id="listFollowAndQuestion" resultType="com.comvee.cdms.follow.model.FollowListModel">
    select * from (
    SELECT a.foreign_id sid,a.fill_form_by fillFormBy, a.next_dt nextDt, a.fill_dt followDt, a.type followType, a.member_id memberId, a.leader_id leaderId,
    a.doctor_id doctorId, a.insert_dt createDt, a.order_id orderId, a.package_name packageName, a.buy_dt buyDt, a.member_name memberName, a.telephone telephone,
    a.modify_dt modifyDt, a.is_valid isValid,a.doctor_name doctorName,a.status dealStatus,a.follow_name followName,a.template_id templateId,a.follow_type fType,
    'follow' flag FROM t_follow_main a ,t_doctor b
    where a.is_valid=1 and a.leader_id = b.doctor_id
    <if test="memberId != null" >
      and a.member_id=#{memberId}
    </if>
    <if test="doctorId != null" >
      and a.leader_id=#{doctorId}
    </if>
    <if test="memberName != null and memberName!=''">
      and a.member_name like concat('%',concat(#{memberName},'%'))
    </if>
    <if test="followType != null" >
      and a.type=#{followType}
    </if>
    <if test="deal != null" >
      <if test="deal">
        and a.status=1
      </if>
      <if test="!deal">
        and a.status=0
      </if>
    </if>
    <if test="operatorId != null and '' != operatorId">
      and a.doctor_id = #{operatorId}
    </if>
    <if test="hospitalId != null and '' != hospitalId">
      and b.hospital_id = #{hospitalId}
    </if>
    <if test="authorityList!=null and authorityList.size()>0">
      and a.type in
      <foreach collection="authorityList" index="index" item="item" open="(" close=")" separator=",">
        #{item}
      </foreach>
    </if>
    <!--UNION  ALL
    select q.sid,'' nextDt,q.commit_dt followDt,q.question_type followType,q.member_id memberId,q.operator_id leaderId,
    q.doctor_id doctorId,q.insert_dt createDt,'' orderId,'' packageName,'' buyDt,m.member_name memberName,
    m.mobile_phone telephone,q.update_dt modifyDt,1 isValid,d.doctor_name doctorName,question_status dealStatus,
    question_name followName,follow_content_id templateId,
    'question' flag  from t_questionnaire q,t_member m,t_doctor d
    where q.member_id=m.member_id and q.operator_id = d.doctor_id
    <if test="memberId != null and '' != memberId">
      and q.member_id = #{memberId}
    </if>
    <if test="doctorId != null and '' != doctorId">
      and q.operator_id = #{doctorId}
    </if>
    <if test="memberName != null and memberName!=''">
      and m.member_name like concat('%',concat(#{memberName},'%'))
    </if>
    <if test="questionType!=null">
      and q.question_type=#{questionType}
    </if>
    <if test="deal != null" >
      <if test="deal">
        and q.question_status = 3
      </if>
      <if test="!deal">
        and q.question_status in (1,2)
      </if>
    </if>-->
    )t
    ORDER BY t.createDt desc
  </select>
<!--2型糖尿病随访表  start-->
  <insert id="insertFollowDiabetes" parameterType="com.comvee.cdms.follow.po.FollowDiabetesPO">
    insert into t_follow_diabetes (sid, follow_type, member_id,doctor_id, is_valid, follow_dt, insert_dt, update_dt, follow_info, mqzywt, zygjcs, yqddmb,xltz,zyxw)
    values (#{sid}, #{followType}, #{memberId},#{doctorId}, 1, #{followDt},now(),  now(), #{followInfo}, #{mqzywt}, #{zygjcs}, #{yqddmb},#{xltz},#{zyxw})
  </insert>
  <update id="modifyFollowDiabetes" parameterType="com.comvee.cdms.follow.po.FollowDiabetesPO">
    update t_follow_diabetes
    <set>
      update_dt = now(),
      <if test="followType != null">
        follow_type = #{followType},
      </if>
      <if test="isValid != null">
        is_valid = #{isValid},
      </if>
      <if test="followDt != null and followDt != ''">
        follow_dt = #{followDt},
      </if>
      <if test="followInfo != null and followInfo != ''">
        follow_info = #{followInfo},
      </if>
      <if test="mqzywt != null and mqzywt != ''">
        mqzywt = #{mqzywt},
      </if>
      <if test="zygjcs != null and zygjcs != ''">
        zygjcs = #{zygjcs},
      </if>
      <if test="yqddmb != null  and yqddmb != ''">
        yqddmb = #{yqddmb},
      </if>
      <if test="xltz != null  and xltz != ''">
        xltz = #{xltz},
      </if>
      <if test="zyxw != null  and zyxw != ''">
        zyxw = #{zyxw},
      </if>
    </set>
    where sid = #{sid}
  </update>

  <select id="getFollowDiabetesById" resultMap="followDiabetes" parameterType="java.lang.String">
    select sid, follow_type, member_id,doctor_id, is_valid, follow_dt, insert_dt, update_dt, follow_info, mqzywt, zygjcs, yqddmb
    from t_follow_diabetes where sid = #{sid}
  </select>

  <select id="getNewFollowDiabetes" resultMap="followDiabetes" parameterType="java.lang.String">
    select b.sid, b.follow_type, b.member_id,b.doctor_id, b.is_valid, b.follow_dt, b.insert_dt, b.update_dt, b.follow_info, b.mqzywt, b.zygjcs, b.yqddmb
    from t_follow_main a,t_follow_diabetes b where a.foreign_id = b.sid and a.is_valid = 1 and a.status = 1
    <if test="memberId != null and memberId != ''">
      and b.member_id = #{memberId}
    </if>
    <if test="followType != null">
      and a.type = #{followType}
    </if>
    order by b.update_dt desc limit 1
  </select>

  <!--2型糖尿病随访表  end-->
  <insert id="insertFollowReport" parameterType="com.comvee.cdms.follow.po.FollowReportPO">
    insert into t_follow_report (sid, follow_id, doctor_id,member_id, report_type, insert_dt,update_dt, is_valid, report_json,week_blood_data,report_num)
    values (#{sid}, #{followId}, #{doctorId},#{memberId}, #{reportType}, now(),now(),1, #{reportJson},#{weekBloodData}, #{reportNum})
  </insert>
  <select id="getFollowReportByFollowId"  resultMap="reportPO">
    select sid, follow_id, doctor_id,member_id, report_type, insert_dt,update_dt, is_valid, report_json, week_blood_data, report_num
    from t_follow_report where follow_id = #{followId} and is_valid = 1
    <if test="deal != null">
      <if test="deal">
        and report_type = #{reportType}
      </if>
      <if test="!deal">
        and report_type != 6
      </if>
    </if>
    limit 1
  </select>

  <select id="listFollowReport"  resultType="com.comvee.cdms.follow.dto.FollowReportDTO" parameterType="com.comvee.cdms.follow.dto.ListFollowReportDTO">
    select a.sid sid, a.follow_id followId, a.doctor_id doctorId,a.member_id memberId, a.report_type reportType, a.insert_dt insertDt,a.update_dt updateDt,
    a.is_valid isValid, a.report_json reportJson,a.week_blood_data weekBloodData, a.report_num reportNum,b.doctor_name doctorName
    from t_follow_report a LEFT join t_doctor b on a.doctor_id = b.doctor_id where a.is_valid = 1
    <if test="memberId != null and memberId != ''">
      and a.member_id = #{memberId}
    </if>
    <if test="doctorId != null and doctorId != ''">
      and a.doctor_id = #{doctorId}
    </if>
    <if test="reportType != null">
      and a.report_type = #{reportType}
    </if>
    order by a.update_dt desc
  </select>

  <select id="listMainFollow" resultMap="mainFollow">
    select sid, type, next_dt, fill_form_by, status, final_fill_form_by, doctor_id, leader_id,
    create_dt, fill_dt, insert_dt, modify_dt, is_valid, foreign_id, member_id, doctor_name,
    order_id, package_name, buy_dt, member_name, telephone, follow_type, follow_name,
    template_id from t_follow_main where is_valid = 1 and status = 1
    <if test="memberId != null and memberId != ''">
      and member_id = #{memberId}
    </if>
    <if test="doctorId != null and doctorId != ''">
      and leader_id = #{doctorId}
    </if>
    order by modify_dt desc
  </select>


  <select id="getFollowReportById" parameterType="java.lang.String" resultMap="reportPO">
    select sid, follow_id, doctor_id,member_id, report_type, insert_dt,update_dt, is_valid, report_json,week_blood_data, report_num
    from t_follow_report where sid = #{sid} limit 1
  </select>

  <select id="listFollowWechat" resultType="com.comvee.cdms.follow.model.FollowListModel">
    SELECT foreign_id sid, next_dt nextDt, fill_dt followDt, type followType, member_id memberId, leader_id leaderId,
    doctor_id doctorId, create_dt createDt, order_id orderId, package_name packageName, buy_dt buyDt, member_name memberName, telephone telephone,
    modify_dt modifyDt, is_valid isValid,doctor_name doctorName,status dealStatus,follow_name followName,template_id templateId FROM t_follow_main
    where is_valid=1
    <if test="memberId != null and memberId!=''" >
      and member_id=#{memberId}
    </if>
<!--     <if test="doctorId != null and doctorId!=''" >
      and leader_id=#{doctorId}
    </if> -->
    <if test="doctorId != null and doctorId!=''" >
      and leader_id=#{memberId}
    </if>    
    <if test="memberName != null and memberName!=''">
      and member_name like concat('%',concat(#{memberName},'%'))
    </if>
    <if test="followType != null and followType!=''" >
      and type=#{followType}
    </if>
    <if test="deal != null" >
      <if test="deal">
        and status=1
      </if>
      <if test="!deal">
        and (status=0 or status=3)
      </if>
    </if>
<!--     <if test="fillFormBy != null and fillFormBy!=''">
      and fill_form_by=#{fillFormBy}
    </if>     -->
    ORDER  BY insert_dt DESC
  </select>
  <!--v4.0.4-->
  <select id="listFollowRemindByParam" resultType="com.comvee.cdms.follow.vo.FollowRemindVO" parameterType="com.comvee.cdms.follow.dto.ListFollowRemindDTO">
    select a.id id, a.title title, a.type type, a.follow_id followId, a.doctor_id doctorId, a.member_id memberId,
    a.member_name memberName, a.is_do isDo,a.is_valid isValid, a.insert_dt insertDt,a.modify_dt modifyDt,
    a.before_day beforeDay,b.fill_form_by fillFormBy ,b.follow_name followName,b.template_id templateId,
    b.status followStatus,b.create_dt followInsertDt,b.next_dt nextDt
    from t_follow_remind a left join t_follow_main b on a.follow_id = b.foreign_id
    join t_member_join_hospital h on h.member_id = a.member_id
    where a.is_valid=1 and a.is_do=0 and h.valid = 1
    <if test="memberName != null and memberName!=''">
      and a.member_name like concat('%',concat(#{memberName},'%'))
    </if>
    <if test="followType != null and followType!=''">
      and b.type = #{followType}
    </if>
    <if test="followType != null and followType!=''">
      and a.type = #{followType}
    </if>
    <if test="templateId != null and templateId!=''">
      and b.template_id = #{templateId}
    </if>
    <if test = "typeList != null and typeList.size()&gt;0">
      and a.type in
      <foreach collection="typeList" open="(" index="index" item="item" separator="," close=")">
        #{item}
      </foreach>
    </if>
    <if test = "followTypeList != null and followTypeList.size()&gt;0">
      and b.type in
      <foreach collection="followTypeList" open="(" index="index" item="item" separator="," close=")">
        #{item}
      </foreach>
    </if>
    <if test="doctorIdList!=null and doctorIdList.size()&gt;0">
      AND a.doctor_id IN
      <foreach collection="doctorIdList" close=")" open="(" index="index" item="item" separator=",">
        #{item}
      </foreach>
    </if>
    <if test="nextDt != null and nextDt!=''">
      and DATE_FORMAT(a.insert_dt,"%Y-%m-%d") = #{nextDt}
    </if>
    <if test="statusList!=null and statusList.size()&gt;0">
      AND b.status IN
      <foreach collection="statusList" close=")" open="(" index="index" item="status" separator=",">
        #{status}
      </foreach>
    </if>
    <if test="hospitalId != null and hospitalId!=''">
      and h.hospital_id = #{hospitalId}
    </if>
    order by a.insert_dt desc
  </select>
  <!--v4.0.4-->
  <select id="listFollowByParam" resultType="com.comvee.cdms.follow.model.FollowListModel" parameterType="com.comvee.cdms.follow.dto.ListFollowDTO">
    SELECT foreign_id sid, fill_form_by fillFormBy,next_dt nextDt, fill_dt followDt, type followType, member_id memberId, leader_id leaderId,
    doctor_id doctorId, DATE_FORMAT(create_dt,'%Y-%m-%d') createDt, order_id orderId, package_name packageName, buy_dt buyDt, member_name memberName, telephone telephone,
    modify_dt modifyDt, is_valid isValid,doctor_name doctorName,status dealStatus,follow_name followName,template_id templateId FROM t_follow_main
    where is_valid=1
    <if test="fillFormBy != null">
      and fill_form_by = #{fillFormBy}
    </if>
    <if test="dealStatus != null" >
      <if test="dealStatus == 0">
        and status in (0,3)
      </if>
    </if>
    ORDER  BY insert_dt DESC
  </select>

<!--v4.2.1-->
  <select id="listMemberFollow" parameterType="com.comvee.cdms.follow.dto.ListMemberFollowDTO" resultType="com.comvee.cdms.follow.model.FollowListModel">
    SELECT foreign_id sid, next_dt nextDt, fill_dt followDt, type followType, member_id memberId, leader_id leaderId,
    doctor_id doctorId, create_dt createDt, order_id orderId, package_name packageName, buy_dt buyDt, member_name memberName, telephone telephone,
    modify_dt modifyDt, is_valid isValid,doctor_name doctorName,status dealStatus,follow_name followName,template_id templateId,follow_type fType,fill_form_by fillFormBy FROM t_follow_main
    where is_valid=1
    <if test="typeList != null and typeList.size() > 0" >
      and type in
      <foreach collection="typeList" item="item" open="(" close=")" separator=",">
        #{item}
      </foreach>
    </if>
    and member_id=#{memberId} and (status in(1,2) or (fill_form_by = 2 and status in(0,3))) order by insert_dt desc
  </select>

  <insert id="insertFollowMmcVisit" parameterType="com.comvee.cdms.follow.po.FollowMmcVisitPO" >
    insert into t_follow_mmc_visit (sid, member_info, follow_info, drug_info,diseases_info,operation_info,other_drug,drinking_info,is_valid,
      insert_dt,modify_dt, member_id,follow_type,deal_status
      )
    values (#{sid,jdbcType=BIGINT}, #{memberInfo,jdbcType=VARCHAR}, #{followInfo,jdbcType=VARCHAR}, #{drugInfo,jdbcType=VARCHAR},#{diseasesInfo,jdbcType=VARCHAR},
     #{operationInfo,jdbcType=VARCHAR},#{otherDrug,jdbcType=VARCHAR},#{drinkingInfo,jdbcType=VARCHAR}, 1, now(),  now(), #{memberId,jdbcType=BIGINT}, #{followType,jdbcType=TINYINT},0
      )
  </insert>

  <update id="modifyFollowMmcVisit" parameterType="com.comvee.cdms.follow.po.FollowMmcVisitPO" >
    update t_follow_mmc_visit
    <set>
      modify_dt = now(),
      <if test="memberInfo != null and memberInfo != ''" >
        member_info = #{memberInfo,jdbcType=VARCHAR},
      </if>
      <if test="followInfo != null and followInfo != ''" >
        follow_info = #{followInfo,jdbcType=VARCHAR},
      </if>
      <if test="drugInfo != null and drugInfo != ''" >
        drug_info = #{drugInfo,jdbcType=VARCHAR},
      </if>
      <if test="diseasesInfo != null and diseasesInfo != ''" >
        diseases_info = #{diseasesInfo,jdbcType=VARCHAR},
      </if>
      <if test="operationInfo != null and operationInfo != ''" >
        operation_info = #{operationInfo,jdbcType=VARCHAR},
      </if>
      <if test="otherDrug != null and otherDrug != ''" >
        other_drug = #{otherDrug,jdbcType=VARCHAR},
      </if>
      <if test="drinkingInfo != null and drinkingInfo != ''" >
        drinking_info = #{drinkingInfo,jdbcType=VARCHAR},
      </if>
      <if test="isValid != null and isValid != ''" >
        is_valid = #{isValid,jdbcType=TINYINT},
      </if>
      <if test="memberId != null and memberId != ''" >
        member_id = #{memberId,jdbcType=BIGINT},
      </if>
      <if test="followType != null and followType != ''" >
        follow_type = #{followType,jdbcType=TINYINT},
      </if>
      <if test="dealStatus != null and dealStatus != ''" >
        deal_status = #{dealStatus}
      </if>
    </set>
    where sid = #{sid,jdbcType=BIGINT}
  </update>

  <!-- 获取随访问卷字典表数据-->
  <select id="getQuestiondate" parameterType="java.lang.String" resultType="com.comvee.cdms.follow.po.FollowQuestionPO">
    select option_id,option_code, option_content, sub_question_code, sub_question_content, option_type, follow_type, parent_name, foreignkey
    from t_follow_question_option
    <where>
      <if test="followType != null and followType != ''" >
        follow_type = #{followType,jdbcType=TINYINT}
      </if>
    </where>
  </select>

  <!-- 获取随访用药字典表数据-->
  <select id="getDrugDICT" resultMap="followDrugDict">
     select  drug_id,drug_name,pid,drug_type from t_follow_drug_dict
  </select>

  <select id="listFollowMmcVisit" parameterType="com.comvee.cdms.follow.po.FollowMmcVisitPO" resultMap="visitPO">
    SELECT sid, member_info, follow_info ,drug_info ,diseases_info,operation_info,other_drug,drinking_info,insert_dt,modify_dt, member_id , follow_type,deal_status
    FROM t_follow_mmc_visit
    <where> is_valid=1
      <if test="memberId != null and memberId != ''" >
        and member_id=#{memberId}
      </if>
      <if test="followType != null and followType != ''" >
        and follow_type = #{followType}
      </if>
      <if test="sid != null and sid != ''" >
        and sid = #{sid}
      </if>
      ORDER  BY insert_dt DESC
    </where>
  </select>

  <select id="getMainFollowByType" parameterType="com.comvee.cdms.follow.dto.ListMemberFollowDTO"
          resultType="com.comvee.cdms.follow.po.MainFollowPO">
    SELECT foreign_id sid, next_dt nextDt, fill_dt followDt, type followType, member_id memberId, leader_id leaderId,
    doctor_id doctorId, create_dt createDt, order_id orderId, package_name packageName, buy_dt buyDt, member_name memberName, telephone telephone,
    modify_dt modifyDt, is_valid isValid,doctor_name doctorName,status dealStatus,follow_name followName,template_id templateId,follow_type fType,fill_form_by fillFormBy
    FROM t_follow_main
    where is_valid=1
    <if test="memberId != null and memberId != '' " >
      and member_id = #{memberId}
    </if>
    <if test="doctorId != null and doctorId != '' " >
      and doctor_id = #{doctorId}
    </if>
    <if test="type != null and type != '' " >
      and type = #{type}
    </if>
    <if test="status != null and status != '' " >
      and status = #{status}
    </if>
  </select>
  <select id="getFollowNumByHospitalId" resultType="java.lang.Long">
    select ifnull(count(t.sid),0)
    from t_follow_main t
    where t.is_valid = 1
    <if test="hospitalIdList!=null and hospitalIdList.size()&gt;0">
      AND t.hospital_id IN
      <foreach collection="hospitalIdList" close=")" open="(" index="index" item="item" separator=",">
        #{item}
      </foreach>
    </if>
    <if test="startDt != null and ''!=startDt">
      and t.create_dt &gt;= #{startDt}
    </if>
    <if test="endDt != null and ''!=endDt">
      and t.create_dt &lt;= #{endDt}
    </if>
  </select>
  <select id="getFollowMemberNumByHospitalId" resultType="java.lang.Long">
    select ifnull(count(distinct(t.member_id)),0)
    from t_follow_main t
    where t.is_valid = 1
    <if test="hospitalIdList!=null and hospitalIdList.size()&gt;0">
      AND t.hospital_id IN
      <foreach collection="hospitalIdList" close=")" open="(" index="index" item="item" separator=",">
        #{item}
      </foreach>
    </if>
    <if test="startDt != null and ''!=startDt">
      and t.create_dt &gt;= #{startDt}
    </if>
    <if test="endDt != null and ''!=endDt">
      and t.create_dt &lt;= #{endDt}
    </if>
  </select>
  <select id="listMemberFollowForPlatform" resultMap="ListFollowPlatformRecordVO">
    select fm.sid,tm.member_id,fd.sid,fd.follow_type,fm.doctor_id,fm.doctor_name,fm.foreign_id,
    fd.follow_dt,fd.xltz,fd.zyxw,tm.member_name,
    tm.mobile_phone,tm.sex,tm.birthday,fm.type,
    case
    when tm.is_diabetes = 1 and tm.essential_hyp = 1 then '高血压-糖尿病'
    when tm.is_diabetes = 1 then '糖尿病' when tm.essential_hyp = 1 then '高血压' else '无' end diseaseType
    from t_follow_main fm join t_follow_diabetes fd on fm.foreign_id = fd.sid
    join t_member tm on tm.member_id = fm.member_id
    join t_member_join_hospital mjh on mjh.member_id = tm.member_id and mjh.valid = 1 and mjh.hospital_id = #{hospitalId}
    where fm.is_valid=1 and fm.status = 1
    <if test="memberId != null and memberId != '' " >
      and fm.member_id = #{memberId}
    </if>
    <if test="type != null">
      and fm.type = #{type}
    </if>
    <if test="typeList != null and typeList.size() > 0" >
      and fm.type in
      <foreach collection="typeList" item="item" open="(" close=")" separator=",">
        #{item}
      </foreach>
    </if>
    <if test="keyword != null and keyword != '' and mobilePhone != null and mobilePhone != '' ">
      and (instr(tm.mobile_phone, #{mobilePhone}) > 0 or instr(tm.member_name, #{keyword}) > 0)
    </if>
    <if test="diseaseType != null">
      <if test='diseaseType == "1"'>
        and tm.is_diabetes = 1
      </if>
      <if test='diseaseType == "2"'>
        and tm.essential_hyp = 1
      </if>
    </if>
    <if test="startDt != null and ''!=startDt">
      and fd.follow_dt &gt;= #{startDt}
    </if>
    <if test="endDt != null and ''!=endDt">
      and fd.follow_dt &lt;= #{endDt}
    </if>
    <if test="xltz != null and ''!=xltz">
      and fd.xltz = #{xltz}
    </if>
    <if test="zyxw != null and ''!=zyxw">
      and fd.zyxw = #{zyxw}
    </if>
    <if test="committeeList != null and committeeList.size() > 0" >
      and tm.committee_id in
      <foreach collection="committeeList" item="item" open="(" close=")" separator=",">
        #{item}
      </foreach>
    </if>
    order by fm.insert_dt desc,tm.insert_dt desc
  </select>
  <select id="countFollowMemberNum" resultType="java.lang.Long">
    select ifnull(count(distinct(fm.member_id)),0)
    from t_follow_main fm join t_follow_diabetes fd on fd.sid = fm.foreign_id
    join t_member tm on tm.member_id = fm.member_id
    join t_member_join_hospital mjh on mjh.member_id = tm.member_id and mjh.valid = 1 and mjh.hospital_id = #{hospitalId}
    <where>
      fm.is_valid=1
      <if test="typeList != null and typeList.size() > 0" >
        and fm.type in
        <foreach collection="typeList" item="item" open="(" close=")" separator=",">
          #{item}
        </foreach>
      </if>
      <if test="startDt != null and ''!=startDt">
        and fd.follow_dt &gt;= #{startDt}
      </if>
      <if test="endDt != null and ''!=endDt">
        and fd.follow_dt &lt;= #{endDt}
      </if>
      <if test="status != null" >
        and fm.status = #{status}
      </if>
      <if test="committeeList != null and committeeList.size() > 0" >
        and tm.committee_id in
        <foreach collection="committeeList" item="item" open="(" close=")" separator=",">
          #{item}
        </foreach>
      </if>
    </where>
  </select>
  <select id="countFollowNum" resultType="java.lang.Long">
    select ifnull(count(distinct(fm.sid)),0)
    from t_follow_main fm join t_follow_diabetes fd on fd.sid = fm.foreign_id
    join t_member tm on tm.member_id = fm.member_id
    join t_member_join_hospital mjh on mjh.member_id = tm.member_id and mjh.valid = 1 and mjh.hospital_id = #{hospitalId}
    <where>
      fm.is_valid=1
      <if test="typeList != null and typeList.size() > 0" >
        and fm.type in
        <foreach collection="typeList" item="item" open="(" close=")" separator=",">
          #{item}
        </foreach>
      </if>
      <if test="startDt != null and ''!=startDt">
        and fd.follow_dt &gt;= #{startDt}
      </if>
      <if test="endDt != null and ''!=endDt">
        and fd.follow_dt &lt;= #{endDt}
      </if>
      <if test="status != null" >
        and fm.status = #{status}
      </if>
      <if test="committeeList != null and committeeList.size() > 0" >
        and tm.committee_id in
        <foreach collection="committeeList" item="item" open="(" close=")" separator=",">
          #{item}
        </foreach>
      </if>
    </where>
  </select>
  <select id="listMemberUnDoFollowForPlatform" resultMap="ListFollowPlatformRecordVO">
    select tm.member_id,tf.sid,tf.follow_type,tf.doctor_id,tf.doctor_name,tf.foreign_id,
    tf.follow_dt,tf.xltz,tf.zyxw,tm.member_name,
    tm.mobile_phone,tm.sex,tm.birthday,tf.type,
    case
    when tm.is_diabetes = 1 and tm.essential_hyp = 1 then '高血压-糖尿病'
    when tm.is_diabetes = 1 then '糖尿病' when tm.essential_hyp = 1 then '高血压' else '无' end diseaseType
    from  t_member tm join t_member_join_hospital mjh on mjh.member_id = tm.member_id and mjh.valid = 1 and mjh.hospital_id = #{hospitalId}
    left join
    (select * from(
    select fm.member_id,fm.sid,fd.follow_type,fm.doctor_id,fm.doctor_name,fm.foreign_id,fd.follow_dt,fd.xltz,fd.zyxw,fm.type,fm.insert_dt
    from t_follow_main fm join t_follow_diabetes fd on fm.foreign_id = fd.sid
    <where>
      fm.is_valid=1 and fm.status = 1
    </where>
    having 1 /*keep orderby*/
    order by fd.insert_dt desc ) a
    group by a.member_id) tf on tf.member_id = tm.member_id
    where  tm.member_id not in
    (
    select distinct(member_id) from t_follow_diabetes where 1=1
    <if test="startDt != null and ''!=startDt">
      and follow_dt &gt;= #{startDt}
    </if>
    <if test="endDt != null and ''!=endDt">
      and follow_dt &lt;= #{endDt}
    </if>
    )
    <if test="memberId != null and memberId != '' " >
      and tm.member_id = #{memberId}
    </if>
    <if test="keyword != null and keyword != '' and mobilePhone != null and mobilePhone != '' ">
      and (instr(tm.mobile_phone, #{mobilePhone}) > 0 or instr(tm.member_name, #{keyword}) > 0)
    </if>
    <if test="diseaseType != null">
      <if test='diseaseType == "1"'>
        and tm.is_diabetes = 1
      </if>
      <if test='diseaseType == "2"'>
        and tm.essential_hyp = 1
      </if>
    </if>
    <if test="committeeList != null and committeeList.size() > 0" >
      and tm.committee_id in
      <foreach collection="committeeList" item="item" open="(" close=")" separator=",">
        #{item}
      </foreach>
    </if>
    order by tf.insert_dt desc,tm.insert_dt desc
  </select>

</mapper>